#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
# –ó–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

set -e

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º"
echo "==================================="
echo ""

# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
echo "1. üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker-compose down
echo ""

# 2. –û—á–∏—Å—Ç–∫–∞ –æ–±—Ä–∞–∑–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏)
read -p "–û—á–∏—Å—Ç–∏—Ç—å Docker –æ–±—Ä–∞–∑—ã? (y/N): " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "üßπ –û—á–∏—Å—Ç–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤..."
    docker-compose down --rmi all
    docker system prune -f
    echo ""
fi

# 3. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
echo "2. üöÄ –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker-compose up -d --build
echo ""

# 4. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
echo "3. ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 30

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "4. üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:"
docker-compose ps
echo ""

# 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
echo "5. üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:"

echo "   - API health:"
curl -s http://localhost/api/health | jq '.' 2>/dev/null || echo "   ‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

echo ""
echo "   - Frontend:"
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/)
if [ "$HTTP_STATUS" = "200" ]; then
    echo "   ‚úÖ Frontend –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "   ‚ùå Frontend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $HTTP_STATUS)"
fi

echo ""
echo "   - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:"
AUTH_TEST=$(curl -s -X POST -H "Content-Type: application/json" -d '{"username": "admin", "password": "admin123"}' http://localhost/api/auth/login)
if echo "$AUTH_TEST" | grep -q "access_token"; then
    echo "   ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "   ‚ùå –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
fi

echo ""

# 7. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
echo "6. üåê –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞:"
echo ""
echo "   –¢–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ:"
echo "   http://37.252.20.46"
echo ""
echo "   –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:"
echo "   –õ–æ–≥–∏–Ω: admin"
echo "   –ü–∞—Ä–æ–ª—å: admin123"
echo ""
echo "   –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞–ª–∏—Å—å:"
echo "   1. –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+F5)"
echo "   2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ"
echo "   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker-compose logs -f"
echo "   4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É: ./debug-browser.sh"
