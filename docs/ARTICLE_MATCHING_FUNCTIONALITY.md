# Функционал сопоставления артикулов

## Описание

Новый функционал позволяет сотрудникам ВЭД загружать заявки от контрагентов в формате Excel и автоматически сопоставлять артикулы с базой данных компании АГБ. Система находит соответствия по описанию товаров, пересчитывает количества с учетом фасовки и выдает готовую таблицу с артикулами АГБ и BL.

## Возможности

### 1. Загрузка заявок контрагентов
- Загрузка Excel файлов с заявками
- Автоматическое извлечение данных о товарах
- Создание структурированных заявок в системе

### 2. Автоматическое сопоставление
- Интеллектуальный поиск соответствий по описанию товаров
- Алгоритм схожести текста для точного сопоставления
- Оценка уверенности в найденных соответствиях (0-100%)

### 3. Пересчет количеств
- Учет коэффициентов фасовки
- Автоматический пересчет количества товаров
- Поддержка различных единиц измерения

### 4. Экспорт результатов
- Экспорт результатов сопоставления в Excel
- Детальная таблица с найденными соответствиями
- Статистика по качеству сопоставления

## Структура базы данных

### Новые таблицы

#### `article_mappings`
Соответствия артикулов контрагентов с базой данных АГБ:
- `contractor_article` - артикул контрагента
- `contractor_description` - описание контрагента
- `agb_article` - артикул АГБ
- `agb_description` - описание АГБ
- `bl_article` - артикул BL (опционально)
- `bl_description` - описание BL (опционально)
- `packaging_factor` - коэффициент фасовки
- `unit` - единица измерения

#### `contractor_requests`
Заявки от контрагентов:
- `request_number` - номер заявки
- `contractor_name` - название контрагента
- `request_date` - дата заявки
- `status` - статус обработки
- `total_items` - общее количество позиций
- `matched_items` - количество сопоставленных позиций

#### `contractor_request_items`
Позиции в заявке контрагента:
- `line_number` - номер строки в заявке
- `contractor_article` - артикул контрагента
- `description` - описание товара
- `quantity` - количество
- `matched_nomenclature_id` - ID сопоставленной номенклатуры
- `agb_article` - найденный артикул АГБ
- `bl_article` - найденный артикул BL
- `packaging_factor` - коэффициент фасовки
- `recalculated_quantity` - пересчитанное количество
- `match_confidence` - уверенность в сопоставлении
- `match_status` - статус сопоставления

## API Endpoints

### Управление соответствиями артикулов
- `GET /api/v1/article-matching/mappings/` - Получение списка соответствий
- `POST /api/v1/article-matching/mappings/` - Создание нового соответствия

### Управление заявками контрагентов
- `GET /api/v1/article-matching/requests/` - Получение списка заявок
- `POST /api/v1/article-matching/requests/` - Создание новой заявки
- `GET /api/v1/article-matching/requests/{id}` - Получение конкретной заявки
- `POST /api/v1/article-matching/upload-excel/` - Загрузка заявки из Excel

### Сопоставление и экспорт
- `POST /api/v1/article-matching/requests/{id}/match` - Сопоставление артикулов
- `PUT /api/v1/article-matching/items/{id}` - Обновление позиции заявки
- `GET /api/v1/article-matching/requests/{id}/export/excel` - Экспорт результатов

## Использование

### 1. Загрузка базы данных соответствий

```bash
cd backend
python scripts/load_article_mappings.py
```

### 2. Создание тестовых данных

```bash
cd backend
python scripts/test_article_matching.py
```

### 3. Доступ к интерфейсу

1. Войдите в систему как пользователь с ролью `ved_passport` или `admin`
2. Перейдите в раздел "Паспорта ВЭД" → "Сопоставление артикулов"
3. Загрузите Excel файл с заявкой контрагента
4. Запустите автоматическое сопоставление
5. Просмотрите результаты и экспортируйте в Excel

## Формат Excel файла

Заявка контрагента должна содержать следующие колонки:
- `Артикул` или `№` - артикул контрагента
- `Описание` или `Наименование` - описание товара
- `Количество` или `Кол-во` - количество товара
- `Ед.` или `Единица` - единица измерения (по умолчанию "шт")
- `Категория` - категория товара (опционально)

## Пример заявки

| Артикул | Описание | Количество | Ед. | Категория |
|---------|----------|------------|-----|-----------|
| 1299650 | Шпиндель верхней части керноприемника H/HU, 25231, SDT | 5 | шт | Для бурения |
| 1298240 | Втулка удержания жидкости 306131, SDT | 12 | шт | Для бурения |
| 1298244 | Пружина мягкая N/H/P, удержания жидкости, 104966, SDT | 10 | шт | Для бурения |

## Алгоритм сопоставления

1. **Извлечение ключевых слов** из описания товара
2. **Поиск по названию** в базе номенклатуры АГБ
3. **Поиск по артикулу** в базе номенклатуры АГБ
4. **Вычисление схожести** с помощью алгоритма SequenceMatcher
5. **Комбинирование оценок** с весовыми коэффициентами
6. **Фильтрация по минимальному порогу** схожести (30%)

## Статусы сопоставления

- `pending` - ожидает сопоставления
- `matched` - найдено соответствие
- `unmatched` - соответствие не найдено
- `manual` - требует ручной обработки

## Уровни уверенности

- **Высокая (80-100%)** - точное соответствие
- **Средняя (60-79%)** - вероятное соответствие
- **Низкая (30-59%)** - возможное соответствие
- **Не найдено (<30%)** - соответствие не найдено

## Безопасность

- Доступ только для пользователей с ролью `ved_passport` или `admin`
- Валидация загружаемых файлов
- Ограничение размера файлов
- Проверка формата данных

## Производительность

- Пакетная обработка больших заявок
- Индексы для быстрого поиска
- Кэширование результатов сопоставления
- Асинхронная обработка

## Мониторинг

- Логирование всех операций
- Статистика по качеству сопоставления
- Отслеживание ошибок обработки
- Метрики производительности

## Развитие функционала

### Планируемые улучшения:
1. Машинное обучение для улучшения точности сопоставления
2. Интеграция с внешними базами данных
3. Автоматическое обновление соответствий
4. Уведомления о новых заявках
5. API для внешних систем
6. Расширенная аналитика и отчетность

### Возможные интеграции:
- 1С:Предприятие
- SAP
- Другие ERP системы
- Внешние поставщики данных



