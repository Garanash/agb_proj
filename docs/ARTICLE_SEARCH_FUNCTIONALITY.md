# Функциональность поиска поставщиков артикулов

## Обзор

Новая функциональность позволяет пользователям искать поставщиков для конкретных артикулов с использованием ИИ (Polza.ai), валидацией контактов и группировкой результатов по компаниям.

## Основные возможности

### 1. Поиск поставщиков через ИИ
- Интеграция с Polza.ai API для поиска поставщиков
- Автоматический поиск максимального количества поставщиков для каждого артикула
- Извлечение контактной информации (email, телефон, сайт, адрес)
- Получение цен и условий поставки

### 2. Валидация контактов
- **Email валидация**: Проверка формата и DNS записей
- **Website валидация**: Проверка доступности сайта
- **Whois проверка**: Получение информации о домене
- Автоматическое логирование результатов валидации

### 3. Группировка по поставщикам
- Группировка найденных артикулов по компаниям-поставщикам
- Отображение всех артикулов, которые может предоставить каждый поставщик
- Расчет средней цены по поставщику
- Сортировка по количеству доступных артикулов

### 4. Реестр поставщиков
- Сохранение найденных поставщиков в базе данных
- Избежание повторного поиска уже известных поставщиков
- История поиска и результатов
- Управление статусом поставщиков

## Техническая архитектура

### Backend (API v3)

#### Модели базы данных

1. **Supplier** - Поставщики
   - Основная информация о компании
   - Контактные данные
   - Статус валидации контактов
   - Данные whois

2. **SupplierArticle** - Артикулы поставщиков
   - Связь с поставщиком
   - Информация об артикуле
   - Цены и условия поставки
   - Связь с номенклатурой АГБ

3. **ArticleSearchRequest** - Запросы на поиск
   - Список артикулов для поиска
   - Статус обработки
   - Статистика результатов

4. **ArticleSearchResult** - Результаты поиска
   - Связь запроса с найденными поставщиками
   - Уверенность в совпадении
   - Анализ ИИ

5. **SupplierValidationLog** - Лог валидации
   - История проверок контактов
   - Результаты валидации

#### API Endpoints

- `POST /api/v3/article-search/search` - Запуск поиска поставщиков
- `GET /api/v3/article-search/requests` - Список запросов поиска
- `GET /api/v3/article-search/requests/{id}` - Детали запроса
- `GET /api/v3/article-search/suppliers/grouped` - Группированные поставщики
- `GET /api/v3/article-search/suppliers` - Список поставщиков
- `POST /api/v3/article-search/suppliers/{id}/validate` - Валидация поставщика

### Frontend

#### Компоненты

1. **ArticleSearchManager** - Основной компонент
   - Вкладка "Новый поиск" - ввод артикулов и настройки
   - Вкладка "Результаты поиска" - история и детали запросов
   - Вкладка "Поставщики" - группированный просмотр

2. **ArticleSearchPage** - Страница поиска поставщиков
   - Доступна через основное боковое меню
   - Проверка прав доступа (admin, manager, ved_passport)

#### Функциональность UI

- **Ввод артикулов**: Динамическое добавление/удаление полей
- **Настройки поиска**: Включение/отключение ИИ и валидации
- **Отображение результатов**: Карточки поставщиков с контактами
- **Группировка**: Просмотр всех артикулов по поставщику
- **Статусы**: Визуальные индикаторы валидации контактов

## Установка и настройка

### 1. Установка зависимостей

```bash
# Backend
pip install dnspython python-whois

# Frontend зависимости уже установлены
```

### 2. Создание таблиц базы данных

```bash
cd backend
python scripts/create_supplier_tables.py
```

### 3. Настройка API ключа Polza.ai

1. Перейдите в админ панель → Настройки → API ключи
2. Добавьте новый ключ:
   - Название: "Polza.ai API"
   - Провайдер: "polza"
   - Ключ: ваш API ключ от Polza.ai

### 4. Настройка переменных окружения

```env
# В .env файле
POLZA_API_KEY=your_polza_api_key_here
```

## Использование

### 1. Запуск поиска поставщиков

1. Перейдите в админ панель → Настройки → Поиск артикулов
2. Введите артикулы для поиска (по одному на строку)
3. Настройте параметры поиска:
   - Использовать ИИ для поиска
   - Валидировать контакты поставщиков
4. Нажмите "Найти поставщиков"

### 2. Просмотр результатов

1. Перейдите на вкладку "Результаты поиска"
2. Выберите запрос для просмотра деталей
3. Для завершенных запросов доступна кнопка "Поставщики"

### 3. Группированный просмотр

1. На вкладке "Поставщики" отображаются все найденные компании
2. Для каждой компании показаны:
   - Контактная информация
   - Статус валидации контактов
   - Все доступные артикулы
   - Цены и условия поставки

## Особенности реализации

### ИИ интеграция

- Использует Polza.ai API для поиска поставщиков
- Парсинг JSON ответов от ИИ
- Fallback на текстовый парсинг при ошибках JSON
- Обработка ошибок API и таймаутов

### Валидация контактов

- **Email**: Проверка формата + DNS MX записей
- **Website**: HTTP запрос + whois данные
- Асинхронная обработка для производительности
- Логирование всех результатов валидации

### Группировка данных

- SQL запросы с JOIN для эффективной группировки
- Расчет статистики (средние цены, количество артикулов)
- Сортировка по релевантности

### Производительность

- Фоновые задачи для длительных операций
- Кэширование результатов поиска
- Индексы базы данных для быстрого поиска
- Пагинация для больших списков

## Мониторинг и логирование

### Логи валидации

Все операции валидации логируются в таблице `supplier_validation_logs`:
- Тип валидации (email, website, whois)
- Статус (success, failed, warning)
- Детали и сообщения об ошибках

### Статистика поиска

- Количество найденных поставщиков
- Процент успешных валидаций
- Время обработки запросов
- Использование API ключей

## Безопасность

### API ключи

- Шифрование API ключей в базе данных
- Ротация ключей
- Логирование использования

### Валидация данных

- Санитизация входных данных
- Проверка прав доступа к запросам
- Ограничения на размер запросов

## Расширения

### Возможные улучшения

1. **Интеграция с внешними API**:
   - Google Maps для геолокации
   - LinkedIn для дополнительной информации о компаниях
   - Торговые площадки для проверки цен

2. **Машинное обучение**:
   - Улучшение алгоритмов сопоставления артикулов
   - Предсказание надежности поставщиков
   - Автоматическая категоризация

3. **Уведомления**:
   - Email уведомления о завершении поиска
   - Telegram бот для статуса
   - Webhook интеграции

4. **Аналитика**:
   - Дашборд с метриками поиска
   - Экспорт результатов в Excel
   - API для внешних систем

## Устранение неполадок

### Частые проблемы

1. **Ошибка API ключа Polza.ai**
   - Проверьте правильность ключа в настройках
   - Убедитесь, что ключ активен и имеет достаточные лимиты

2. **Ошибки валидации email**
   - Проверьте интернет соединение
   - Убедитесь, что DNS серверы доступны

3. **Медленный поиск**
   - Проверьте статус Polza.ai API
   - Уменьшите количество артикулов в одном запросе
   - Проверьте логи на ошибки

4. **Не отображаются результаты**
   - Проверьте права доступа пользователя
   - Убедитесь, что запрос завершен (статус "completed")
   - Проверьте логи браузера на ошибки JavaScript

### Логи и отладка

- Backend логи: `backend/backend.log`
- Browser консоль: F12 → Console
- Network запросы: F12 → Network
- База данных: проверьте таблицы `suppliers`, `supplier_articles`, `article_search_requests`
