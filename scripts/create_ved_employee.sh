#!/bin/bash

echo "üë§ –°–û–ó–î–ê–ù–ò–ï –°–û–¢–†–£–î–ù–ò–ö–ê –í–≠–î"
echo "=========================="

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
USERNAME="d.li"
PASSWORD="123456"
EMAIL="d.li@example.com"
FIRST_NAME="–î–º–∏—Ç—Ä–∏–π"
LAST_NAME="–õ–∏"
MIDDLE_NAME=""
ROLE="ved_passport"
DEPARTMENT_ID=""
POSITION="–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –í–≠–î"

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
ADMIN_USERNAME="admin"
ADMIN_PASSWORD="rNHVZ29Xcpi6"
API_URL="http://localhost:8000"

echo "üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ–∑–¥–∞–≤–∞–µ–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
echo "  –õ–æ–≥–∏–Ω: $USERNAME"
echo "  –ü–∞—Ä–æ–ª—å: $PASSWORD"
echo "  Email: $EMAIL"
echo "  –ò–º—è: $FIRST_NAME"
echo "  –§–∞–º–∏–ª–∏—è: $LAST_NAME"
echo "  –û—Ç—á–µ—Å—Ç–≤–æ: $MIDDLE_NAME"
echo "  –†–æ–ª—å: $ROLE"
echo "  –î–æ–ª–∂–Ω–æ—Å—Ç—å: $POSITION"

# –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
echo ""
echo "üîë –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞..."
TOKEN_RESPONSE=$(curl -s -X POST "$API_URL/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d "{\"username\": \"$ADMIN_USERNAME\", \"password\": \"$ADMIN_PASSWORD\"}")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
if echo "$TOKEN_RESPONSE" | grep -q "access_token"; then
    TOKEN=$(echo "$TOKEN_RESPONSE" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
    echo "‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω: ${TOKEN:0:20}..."
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
    echo "–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $TOKEN_RESPONSE"
    exit 1
fi

# –®–∞–≥ 2: –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
echo ""
echo "üë§ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –í–≠–î..."
CREATE_RESPONSE=$(curl -s -X POST "$API_URL/api/v1/users/" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d "{
    \"username\": \"$USERNAME\",
    \"email\": \"$EMAIL\",
    \"first_name\": \"$FIRST_NAME\",
    \"last_name\": \"$LAST_NAME\",
    \"middle_name\": \"$MIDDLE_NAME\",
    \"role\": \"$ROLE\",
    \"password\": \"$PASSWORD\",
    \"department_id\": $DEPARTMENT_ID,
    \"position\": \"$POSITION\",
    \"is_active\": true,
    \"is_password_changed\": true
  }")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è
if echo "$CREATE_RESPONSE" | grep -q "id"; then
    echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
    echo ""
    echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞–Ω–Ω–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:"
    echo "$CREATE_RESPONSE" | jq '.'
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
    echo "–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $CREATE_RESPONSE"
    exit 1
fi

# –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
VERIFY_RESPONSE=$(curl -s -X GET "$API_URL/api/v1/users/list" \
  -H "Authorization: Bearer $TOKEN")

# –ò—â–µ–º —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if echo "$VERIFY_RESPONSE" | grep -q "$USERNAME"; then
    echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    USER_INFO=$(echo "$VERIFY_RESPONSE" | jq ".users[] | select(.username == \"$USERNAME\")")

    if [ -n "$USER_INFO" ]; then
        echo ""
        echo "üìã –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:"
        echo "$USER_INFO" | jq '.'
    fi
else
    echo "‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
fi

echo ""
echo "üéâ –°–û–ó–î–ê–ù–ò–ï –°–û–¢–†–£–î–ù–ò–ö–ê –í–≠–î –ó–ê–í–ï–†–®–ï–ù–û!"
echo ""
echo "üîë –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:"
echo "  –õ–æ–≥–∏–Ω: $USERNAME"
echo "  –ü–∞—Ä–æ–ª—å: $PASSWORD"
echo "  Email: $EMAIL"
echo "  –†–æ–ª—å: $ROLE"
echo ""
echo "üåê –î–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ:"
echo "  URL: http://localhost:3000"
echo "  –ò–ª–∏: http://$(curl -s ifconfig.me || echo 'YOUR_SERVER_IP')"
