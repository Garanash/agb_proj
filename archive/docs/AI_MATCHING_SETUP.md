# Настройка ИИ-агента для сопоставления артикулов

## Обзор функциональности

ИИ-агент позволяет загружать любые документы (PDF, Excel, изображения) и автоматически сопоставлять найденные артикулы с базой данных АГБ.

## Компоненты системы

### Frontend
- **Новая вкладка "АИ сопоставление"** в разделе сопоставления артикулов
- **Чат-интерфейс** для загрузки файлов и общения с ИИ
- **Таблица результатов** сопоставления в реальном времени
- **Настройки API ключей** в админ панели

### Backend
- **API endpoints** для обработки файлов и ИИ запросов
- **Поддержка множественных форматов**: PDF, Excel, CSV, изображения
- **OCR сервис** на базе Tesseract для распознавания текста
- **Интеграция с OpenAI и Polza.ai**

### Docker сервисы
- **OCR контейнер** с Tesseract для обработки изображений
- **Автоматическое масштабирование** и health checks

## Установка и настройка

### 1. Установка зависимостей

```bash
# Backend зависимости
pip install openai pytesseract pandas openpyxl PyPDF2 Pillow requests cryptography

# Frontend зависимости уже установлены
```

### 2. Настройка переменных окружения

Добавьте в `.env` файл:

```env
# API ключи
OPENAI_API_KEY=your_openai_key_here
POLZA_API_KEY=your_polza_key_here

# OCR сервис
OCR_SERVICE_URL=http://localhost:8001

# Шифрование API ключей
API_KEY_ENCRYPTION_KEY=your_encryption_key_here
```

### 3. Создание таблиц базы данных

```bash
cd backend
python scripts/add_ai_models.py
```

### 4. Запуск сервисов

```bash
# Запуск всех сервисов включая OCR
docker-compose -f docker-compose.dev.yml up -d

# Или только OCR сервис
docker-compose -f docker-compose.dev.yml up -d ocr
```

### 5. Настройка API ключей

1. Войдите в систему как администратор
2. Перейдите в "Настройки системы" → "API ключи"
3. Добавьте ключи для OpenAI и/или Polza.ai

## Использование

### Загрузка документов

1. Откройте раздел "Сопоставление артикулов"
2. Перейдите на вкладку "АИ сопоставление"
3. Загрузите файл или введите текст
4. Получите результаты сопоставления в таблице

### Поддерживаемые форматы

- **PDF**: Автоматическое извлечение текста
- **Excel/CSV**: Парсинг табличных данных
- **Изображения**: OCR распознавание (JPG, PNG, GIF, BMP, TIFF, WebP)

### Настройка ИИ провайдеров

#### OpenAI
- Получите API ключ на https://platform.openai.com/
- Добавьте в настройки системы
- Используется GPT-3.5-turbo для анализа документов

#### Polza.ai
- Получите API ключ на https://polza.ai/
- Добавьте в настройки системы
- Специализированный сервис для анализа документов

## Архитектура

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Frontend      │    │    Backend       │    │   OCR Service   │
│                 │    │                  │    │                 │
│ - Chat UI       │───▶│ - File Upload    │───▶│ - Tesseract     │
│ - File Drop     │    │ - AI Processing  │    │ - Image OCR     │
│ - Results Table │    │ - DB Matching    │    │ - Multi-lang    │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                       │                       │
         │                       ▼                       │
         │              ┌──────────────────┐              │
         │              │   AI Providers   │              │
         │              │                  │              │
         └─────────────▶│ - OpenAI API     │◀─────────────┘
                        │ - Polza.ai API   │
                        │ - Custom APIs    │
                        └──────────────────┘
```

## Мониторинг и логи

### Логи ИИ обработки
- Доступны в админ панели
- Включают время обработки, статус, ошибки
- Связь с пользователями и API ключами

### Health checks
- OCR сервис: `http://localhost:8001/health`
- Backend API: `http://localhost:8000/api/v1/health`

## Безопасность

### Шифрование API ключей
- Все API ключи шифруются перед сохранением в БД
- Используется Fernet (AES 128) шифрование
- Ключ шифрования хранится в переменных окружения

### Права доступа
- Только администраторы могут управлять API ключами
- Пользователи с ролью `ved_passport` и `admin` могут использовать ИИ-агента
- Логи доступны только администраторам

## Устранение неполадок

### OCR не работает
1. Проверьте, что OCR сервис запущен: `docker ps | grep ocr`
2. Проверьте логи: `docker logs agb_ocr_dev`
3. Убедитесь, что Tesseract установлен в контейнере

### ИИ не отвечает
1. Проверьте API ключи в настройках
2. Убедитесь, что ключ активен
3. Проверьте логи в админ панели

### Файлы не загружаются
1. Проверьте размер файла (максимум 50MB)
2. Убедитесь, что формат поддерживается
3. Проверьте права на запись в папку uploads

## Производительность

### Рекомендации
- Используйте SSD для хранения файлов
- Настройте Redis для кэширования
- Мониторьте использование API ключей
- Регулярно очищайте старые файлы

### Масштабирование
- OCR сервис можно масштабировать горизонтально
- Добавьте load balancer для распределения нагрузки
- Используйте очереди для обработки больших файлов
