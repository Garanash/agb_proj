# Makefile –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è n8n –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π

.PHONY: help n8n-start n8n-stop n8n-restart n8n-logs n8n-status n8n-clean n8n-setup n8n-test

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN=\033[0;32m
YELLOW=\033[1;33m
RED=\033[0;31m
NC=\033[0m # No Color

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
	@echo "$(GREEN)AGB Platform - n8n Integration Management$(NC)"
	@echo ""
	@echo "$(YELLOW)–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)

n8n-setup: ## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ n8n (—Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –∏ —Ñ–∞–π–ª–æ–≤)
	@echo "$(YELLOW)üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ n8n...$(NC)"
	@mkdir -p config/docker/n8n/workflows
	@mkdir -p config/docker/n8n/credentials
	@mkdir -p config/env
	@if [ ! -f config/env/n8n.env ]; then \
		echo "$(YELLOW)‚ö†Ô∏è  –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª config/env/n8n.env –Ω–∞ –æ—Å–Ω–æ–≤–µ config/env/n8n.env.example$(NC)"; \
	fi
	@echo "$(GREEN)‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞$(NC)"

n8n-start: n8n-setup ## –ó–∞–ø—É—Å–∫ n8n
	@echo "$(YELLOW)üöÄ –ó–∞–ø—É—Å–∫ n8n...$(NC)"
	@./scripts/start-n8n.sh
	@echo "$(GREEN)‚úÖ n8n –∑–∞–ø—É—â–µ–Ω$(NC)"

n8n-stop: ## –û—Å—Ç–∞–Ω–æ–≤–∫–∞ n8n
	@echo "$(YELLOW)üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ n8n...$(NC)"
	@docker-compose -f config/docker/docker-compose.n8n.yml down
	@echo "$(GREEN)‚úÖ n8n –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω$(NC)"

n8n-restart: n8n-stop n8n-start ## –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ n8n

n8n-logs: ## –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ n8n
	@echo "$(YELLOW)üìã –õ–æ–≥–∏ n8n:$(NC)"
	@docker logs agb_n8n -f

n8n-status: ## –°—Ç–∞—Ç—É—Å n8n
	@echo "$(YELLOW)üìä –°—Ç–∞—Ç—É—Å n8n:$(NC)"
	@docker ps | grep -E "(n8n|redis)" || echo "$(RED)‚ùå n8n –Ω–µ –∑–∞–ø—É—â–µ–Ω$(NC)"

n8n-health: ## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è n8n
	@echo "$(YELLOW)üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è n8n...$(NC)"
	@curl -s http://localhost:5678/healthz > /dev/null && echo "$(GREEN)‚úÖ n8n –∑–¥–æ—Ä–æ–≤$(NC)" || echo "$(RED)‚ùå n8n –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω$(NC)"

n8n-clean: ## –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö n8n (–í–ù–ò–ú–ê–ù–ò–ï: —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!)
	@echo "$(RED)‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ n8n!$(NC)"
	@read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? (y/N): " confirm && [ "$$confirm" = "y" ]
	@docker-compose -f config/docker/docker-compose.n8n.yml down -v
	@docker volume rm agb_proj_n8n_data agb_proj_redis_data 2>/dev/null || true
	@echo "$(GREEN)‚úÖ –î–∞–Ω–Ω—ã–µ n8n –æ—á–∏—â–µ–Ω—ã$(NC)"

n8n-test: ## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
	@echo "$(YELLOW)üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏...$(NC)"
	@curl -X POST http://localhost:8000/api/v1/n8n/events/passport-created \
		-H "Content-Type: application/json" \
		-d '{"passport_number": "TEST-001", "order_number": "ORDER-001", "creator": {"first_name": "Test", "last_name": "User"}}' \
		&& echo "$(GREEN)‚úÖ –¢–µ—Å—Ç –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ$(NC)" || echo "$(RED)‚ùå –¢–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª$(NC)"

n8n-backup: ## –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ n8n
	@echo "$(YELLOW)üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...$(NC)"
	@mkdir -p backups/n8n
	@docker exec agb_n8n tar -czf /tmp/n8n-backup.tar.gz -C /home/node/.n8n .
	@docker cp agb_n8n:/tmp/n8n-backup.tar.gz backups/n8n/n8n-backup-$(shell date +%Y%m%d-%H%M%S).tar.gz
	@echo "$(GREEN)‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞ –≤ backups/n8n/$(NC)"

n8n-restore: ## –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
	@echo "$(YELLOW)üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...$(NC)"
	@ls -la backups/n8n/ || echo "$(RED)‚ùå –ù–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π$(NC)"
	@read -p "–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: " file && \
		docker cp backups/n8n/$$file agb_n8n:/tmp/restore.tar.gz && \
		docker exec agb_n8n tar -xzf /tmp/restore.tar.gz -C /home/node/.n8n
	@echo "$(GREEN)‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ$(NC)"

n8n-update: ## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ n8n
	@echo "$(YELLOW)üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ n8n...$(NC)"
	@docker-compose -f config/docker/docker-compose.n8n.yml pull
	@docker-compose -f config/docker/docker-compose.n8n.yml up -d
	@echo "$(GREEN)‚úÖ n8n –æ–±–Ω–æ–≤–ª–µ–Ω$(NC)"

n8n-shell: ## –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É n8n
	@echo "$(YELLOW)üêö –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ n8n...$(NC)"
	@docker exec -it agb_n8n /bin/sh

n8n-db-shell: ## –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö n8n
	@echo "$(YELLOW)üóÑÔ∏è  –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î n8n...$(NC)"
	@docker exec -it test_platform_postgres psql -U n8n_user -d n8n

n8n-workflows: ## –°–ø–∏—Å–æ–∫ workflows
	@echo "$(YELLOW)üìã Workflows n8n:$(NC)"
	@curl -s http://localhost:5678/api/v1/workflows | jq '.[].name' 2>/dev/null || echo "$(RED)‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å workflows$(NC)"

n8n-executions: ## –°–ø–∏—Å–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π
	@echo "$(YELLOW)üìä –í—ã–ø–æ–ª–Ω–µ–Ω–∏—è n8n:$(NC)"
	@curl -s http://localhost:5678/api/v1/executions | jq '.[0:5] | .[] | {id: .id, status: .status, startedAt: .startedAt}' 2>/dev/null || echo "$(RED)‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è$(NC)"

# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º Makefile
include Makefile
