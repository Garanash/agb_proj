#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ Felix Platform..."

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üì¶ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose -f docker-compose.prod.yml down

# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ–±—Ä–∞–∑—ã
echo "üóëÔ∏è –£–¥–∞–ª—è—é –≤—Å–µ –æ–±—Ä–∞–∑—ã..."
docker rmi $(docker images -q) 2>/dev/null || true

# –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üßπ –û—á–∏—â–∞—é –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker container prune -f

# –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ volumes
echo "üóÇÔ∏è –û—á–∏—â–∞—é –≤—Å–µ volumes..."
docker volume prune -f

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–Ω–æ–≤–æ
echo "üèóÔ∏è –°–æ–±–∏—Ä–∞—é –∏ –∑–∞–ø—É—Å–∫–∞—é –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã..."
docker-compose -f docker-compose.prod.yml up -d --build

# –ü–æ–¥–æ–∂–¥–∞—Ç—å –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –ñ–¥—É –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 60

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
docker-compose -f docker-compose.prod.yml ps

echo "‚úÖ –ó–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost"
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ API: curl http://localhost/health"
